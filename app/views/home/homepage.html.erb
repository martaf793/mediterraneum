<% today = Date.today %>
<% start_of_week = today - ((today.wday + 6) % 7) %>
<% assignments_by_date = @list_of_assigned_meals.group_by { |am| am.assigned_to } %>

<h1 class="my-3">Weekly Meal Plan </h1>
<p> <%= current_user.email%> </p>

<div class="container-fluid px-3">
  <div class="row" style="display: flex; flex-wrap: nowrap; overflow-x: auto;">
    <% (0..6).each do |offset| %>
      <% day = start_of_week + offset %>
      <% todays = assignments_by_date.fetch(day, []).sort_by(&:created_at) %>

      <div class="col" style="min-width: 14.28%; max-width: 14.28%; flex: 0 0 14.28%;">
        <div class="card h-100 p-2">
          <div class="card-body p-2">
            <h6 class="card-title text-center fw-bold mb-2" style="font-size: 0.9rem;">
              <%= day.strftime("%A") %><br><%= day.strftime("%b %e") %>
            </h6>

            <% if todays.any? %>
              <ul class="ps-3 mb-0" style="font-size: 0.85rem; list-style-type: disc;">
                <% todays.each do |assignment| %>
                  <% if assignment.dish.present? %>
                    <li style="line-height: 1.3;">
                      <a href="/assigned_meals/<%= assignment.id %>">
                        <%= assignment.dish.name %>
                      </a>
                    </li>
                  <% end %>
                <% end %>
              </ul>
            <% else %>
              <p class="text-muted text-center mb-0" style="font-size: 0.8rem;">
                <a href="/assigned_meals">Assign a dish</a>
              </p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>



<% summary_by_day_and_group = {} %>
<% (0..6).each do |offset| %>
  <% day = start_of_week + offset %>
  <% todays = assignments_by_date.fetch(day, []) %>

  <% @food_groups.each do |fg| %>
    <% summary_by_day_and_group[[day, fg.name]] = 0 %>
  <% end %>

  <% todays.each do |assignment| %>
    <% if assignment.dish.present? %>
      <% dish_food_groups = assignment.dish.dish_food_groups %>
      <% if dish_food_groups.present? %>
        <% dish_food_groups.each do |dfg| %>
          <% fg_name = dfg.food_group.name %>
          <% summary_by_day_and_group[[day, fg_name]] += dfg.number_of_instances.to_i %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>



<% weekly_totals = Hash.new(0) %>
<% summary_by_day_and_group.each do |(day, fg_name), count| %>
  <% weekly_totals[fg_name] += count %>
<% end %>

<% recommended_per_week = {
  "vegetables" => "14/week",
  "legumes" => "2–4/week",
  "fish" => "2–4/week",
  "eggs" => "3–5/week",
  "white meat" => "2–3/week",
  "red meat" => "1/week",
  "whole grains" => "7/week"
} %>
<h2>Summary of Food Groups per Day</h2>
<table border="1">
  <tr>
    <th>Food Group</th>
    <% (0..6).each do |offset| %>
      <% day = start_of_week + offset %>
      <th><%= day.strftime("%a %b %e") %></th>
    <% end %>
    <th>Total (week)</th>
    <th>Recommended</th>
  </tr>

  <% @food_groups.each do |fg| %>
    <tr>
      <td>
        <a href="/food_groups/<%= fg.id %>">
              <%= fg.name %>
        </a>
      </td>
      <% (0..6).each do |offset| %>
        <% day = start_of_week + offset %>
        <td><%= summary_by_day_and_group[[day, fg.name]] %></td>
      <% end %>
      <td><%= weekly_totals[fg.name] %></td>

      <% recommended = recommended_per_week[fg.name] %>
      <td>
        <% if recommended.present? %>
          <%= recommended %>
        <% end %>
      </td>
    </tr>
  <% end %>
</table>
